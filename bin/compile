#!/bin/bash

BUILD_DIR=${1:-}
CACHE_DIR=${2:-}
ENV_DIR=${3:-}

APP_DIR=/app

set -e
set -u

cd $APP_DIR

mkdir -p bin
export PATH=$APP_DIR/bin:$PATH

echo "--> install lix"
npm install lix

# lix installs its own haxe and haxelib scripts that must override
# /usr/bin/haxe and /usr/bin/haxelib
export PATH=$APP_DIR/node_modules/.bin/:$PATH

echo "--> install templo"
haxelib setup $APP_DIR/haxelib
haxelib install templo

echo "--> install temploc2 with templo"
cd bin
haxelib run templo
cd $APP_DIR

SRV_DIR=$APP_DIR/srv
mkdir -p $SRV_DIR

echo "--> copy source files in $SRV_DIR"
cp -r $BUILD_DIR/common/ $SRV_DIR/common/
cp -r $BUILD_DIR/data/ $SRV_DIR/data/
cp -r $BUILD_DIR/js/ $SRV_DIR/js/
cp -r $BUILD_DIR/lang/ $SRV_DIR/lang/
cp -r $BUILD_DIR/src/ $SRV_DIR/src/
cp -r $BUILD_DIR/www/ $SRV_DIR/www/
cp -r $BUILD_DIR/plugins/ $SRV_DIR/plugins/
cp -r $BUILD_DIR/backend/ $SRV_DIR/backend/

echo "--> lix  install backend"
cd $SRV_DIR/backend
lix scope create
lix install haxe 4.0.5
lix use haxe 4.0.5
lix download

cp -r $BUILD_DIR/frontend/ $SRV_DIR/frontend/

echo "--> lix  install frontend"
cd $SRV_DIR/frontend
lix scope create
lix use haxe 4.0.5
lix download
npm install

echo "--> copy config"
cp $BUILD_DIR/config.xml.dist $SRV_DIR/config.xml
cp $BUILD_DIR/apache-scalingo.conf $APP_DIR

echo "--> haxe build backend"
cd $SRV_DIR/backend
haxe build.hxml -D i18n_generation;

echo "--> haxe build frontend"
cd $SRV_DIR/frontend
haxe build.hxml

echo "--> generate mtt files"
cd $SRV_DIR/lang/fr/tpl/
neko ../../../backend/temploc2.n -macros macros.mtt -output ../tmp/ *.mtt */*.mtt */*/*.mtt */*/*/*.mtt */*/*/*/*.mtt

cd $SRV_DIR

echo "--> copy scripts"
# holds connexion config
cp -r $BUILD_DIR/scripts/ $SRV_DIR/scripts/
cp $BUILD_DIR/config.xml.dist config-raw.xml

#USER root

echo "--> setup profile script"
cd $BUILD_DIR
mkdir -p .profile.d

cat > ".profile.d/update.sh" <<SH
export PATH="\$HOME/.apt/usr/sbin:\$PATH"
export PERL5LIB="\$HOME/.apt/usr/share/perl5"
cd \$HOME/srv
perl \$HOME/scripts/update-config.pl config-raw.xml config.xml
SH

echo "--> all done"
